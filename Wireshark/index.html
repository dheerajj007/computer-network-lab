<!DOCTYPE html>
<html>

<head>
  <title>Add Accounts</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
  <style>
    .rate-group {
      margin-bottom: 10px;
    }

    .tier-group {
      margin-left: 20px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Add Accounts</h1>
    <form id="accountForm">
      <div id="accountFields"></div>

      <div class="form-group">
        <button type="button" class="btn btn-primary" onclick="addAccount()">Add Account</button>
      </div>

      <button type="submit" class="btn btn-primary">Submit</button>
    </form>
  </div>

  <script>
    var accountCounter = 1; // Counter for dynamically generated account fields

    function addAccount() {
      var accountDiv = document.createElement('div');
      accountDiv.id = 'account' + accountCounter;

      var accountFieldsHtml = `
        <hr>
        <h4>Account ${accountCounter}</h4>
        <div class="form-group">
          <label for="accountId${accountCounter}">Account ID:</label>
          <input type="text" class="form-control" id="accountId${accountCounter}" required>
        </div>
        <div class="form-group">
          <button type="button" class="btn btn-primary" onclick="addRate(${accountCounter})">Add Rate</button>
        </div>
      `;

      accountDiv.innerHTML = accountFieldsHtml;

      document.getElementById('accountFields').appendChild(accountDiv);

      addRate(accountCounter); // Add the first rate field for the newly added account

      accountCounter++;
    }

    function addRate(accountId) {
      var rateDiv = document.createElement('div');
      rateDiv.className = 'rate-group';

      var rateFieldsHtml = `
        <div class="form-group">
          <label for="rateDate${accountId}">Rate Date:</label>
          <input type="text" class="form-control" id="rateDate${accountId}" required>
        </div>
        <div class="form-group">
          <button type="button" class="btn btn-primary" onclick="addTier(${accountId}, ${document.querySelectorAll('.rate-group').length})">Add Tier</button>
        </div>
        <div id="tierFields${accountId}-${document.querySelectorAll('.rate-group').length}"></div>
      `;

      rateDiv.innerHTML = rateFieldsHtml;

      document.getElementById('account' + accountId).appendChild(rateDiv);
    }

    function addTier(accountId, rateIndex) {
      var tierDiv = document.createElement('div');
      tierDiv.className = 'tier-group';

      var tierFieldsHtml = `
        <div class="form-group">
          <label for="tierPrice${accountId}-${rateIndex}">Tier Price:</label>
          <input type="number" step="0.01" class="form-control" id="tierPrice${accountId}-${rateIndex}" required>
        </div>
      `;

      tierDiv.innerHTML = tierFieldsHtml;

      document.getElementById('tierFields' + accountId + '-' + rateIndex).appendChild(tierDiv);
    }

    document.getElementById('accountForm').addEventListener('submit', function (e) {
      e.preventDefault(); // Prevent form submission

      var accounts = [];

      for (var i = 1; i < accountCounter; i++) {
        var accountId = document.getElementById('accountId' + i).value;

        var rates = [];
        var rateDivs = document.querySelectorAll('#account' + i + ' .rate-group');
        rateDivs.forEach(function (rateDiv, rateIndex) {
          var rateDate = rateDiv.querySelector('input[type="text"]').value;

          var tiers = [];
          var tierDivs = rateDiv.querySelectorAll('.tier-group');
          tierDivs.forEach(function (tierDiv) {
            var tierPrice = parseFloat(tierDiv.querySelector('input[type="number"]').value);

            tiers.push({
              price: tierPrice
            });
          });

          rates.push({
            date: rateDate,
            tiers: tiers
          });
        });

        accounts.push({
          id: accountId,
          rates: rates
        });
      }

      console.log(accounts);
    });
  </script>
</body>

</html>